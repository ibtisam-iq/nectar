# Q-11 â€” Sidecar Logging (Final, Updated for Kubernetes v1.33 GA)

## â­ Kubernetes v1.33 â€” Official Sidecar Model (GA)

Starting from **Kubernetes v1.33**, the **Native Sidecar Containers** feature is **GA (Generally Available)**. This means:

* Sidecars are **no longer defined under `containers:`**.
* Sidecars are **defined under `initContainers:`**.
* Sidecars use **`restartPolicy: Always`**.
* This causes the init container to **run alongside the main container permanently**, not just during startup.

Because the CKA exam environment runs on **v1.33**, this is now the **expected and correct method** for implementing sidecars.

The old (classic) pattern under `containers:` still works, but it is now considered **legacy**.

---

# ğŸ“Œ Question Summary

A Deployment named **synergy-deployment** runs a main application container. The application writes logs to:

```
/var/log/synergy-deployment.log
```

You must:

1. Add a **sidecar** that continuously tails this log file.
2. Use image: `busybox:stable`.
3. Command:

   ```
   tail -n+1 -f /var/log/synergy-deployment.log
   ```
4. Use a **shared volume** between main container and sidecar.
5. Implement this using the **Native Sidecar Model** (since v1.33).

---

# âœ… Native Sidecar Pattern (v1.33 GA) â€” **Primary Solution**

This is the **correct approach** for CKA 2025.

## ğŸ“ Step-by-Step Solution

### **1. Edit the Deployment**

```bash
kubectl edit deployment synergy-deployment
```

---

### **2. Add a shared volume at pod level**

```yaml
volumes:
  - name: logs
    emptyDir: {}
```

---

### **3. Mount the volume into the main container**

```yaml
volumeMounts:
  - name: logs
    mountPath: /var/log
```

---

### **4. Add the sidecar under `initContainers` with `restartPolicy: Always`**

This is what transforms it into a **native sidecar**.

```yaml
initContainers:
- name: sidecar
  image: busybox:stable
  restartPolicy: Always
  command: ["/bin/sh", "-c"]
  args:
    - tail -n+1 -f /var/log/synergy-deployment.log
  volumeMounts:
    - name: logs
      mountPath: /var/log
```

---

### **5. Save and allow rollout**

Kubernetes will restart pods automatically.

---

### **6. Verify**

```bash
kubectl get pods -l app=synergy
kubectl logs <pod> -c sidecar -f
```

You should see the live log stream.

---

# ğŸ§¾ Full Final Deployment Manifest (Native Sidecar, v1.33 GA)

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: synergy-deployment
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: synergy
  template:
    metadata:
      labels:
        app: synergy
    spec:
      volumes:
      - name: logs
        emptyDir: {}

      initContainers:
      - name: sidecar
        image: busybox:stable
        restartPolicy: Always
        command: ["/bin/sh", "-c"]
        args:
          - tail -n+1 -f /var/log/synergy-deployment.log
        volumeMounts:
          - name: logs
            mountPath: /var/log

      containers:
      - name: legacy-app
        image: busybox:stable
        command: ["/bin/sh", "-c"]
        args:
          - |
            while true; do
              echo "$(date) - legacy app log entry" >> /var/log/synergy-deployment.log;
              sleep 5;
            done
        volumeMounts:
          - name: logs
            mountPath: /var/log
```

---

# ğŸŸ¦ Legacy Pattern (For Reference Only)

**Not recommended for CKA 2025**, but included here for completeness.

Sidecar defined under `containers:`:

```yaml
containers:
- name: sidecar
  image: busybox:stable
  command: ["/bin/sh", "-c"]
  args:
    - tail -n+1 -f /var/log/synergy-deployment.log
  volumeMounts:
    - name: logs
      mountPath: /var/log
```

---

# âš ï¸ Important Volume Handling Rules (Common Exam Traps)

These points MUST be remembered because this is where most students fail â€” and this is exactly what confused you in the exam.

## âœ… 1. If the Deployment **already has a volume**, you MUST reuse that same volume

* Do **NOT** create a new volume if one is already defined.
* Kubernetes questions often give an existing volume so you **attach it to the sidecar + main container**.
* Using a different or new volume would result in an empty directory â†’ sidecar reads nothing.

**Rule:**

> *If a volume exists â†’ reuse it.*

---

## âœ… 2. If the Deployment has **no existing volume**, you MUST create one

* Use `emptyDir: {}` unless the question explicitly requires persistence.
* Mount it into BOTH:

  * the main container (so it writes logs into the shared volume)
  * the sidecar (so it can read the logs)

**Rule:**

> *If no volume exists â†’ create one AND mount it in both containers.*

---

## âœ… 3. Why BOTH containers must mount the volume

* Without mounting the volume in the **main container**, the main container writes logs to its own container filesystem.
* The sidecar would mount the volume, but the directory would be **empty**.
* Therefore, **double-mounting is mandatory**.

**Rule:**

> *A shared log file MUST come from a shared volume. Otherwise the sidecar cannot see it.*

---

## âœ… 4. Where to write the volumeMounts in Native Sidecar Pattern

* Main container â†’ under `containers:`
* Sidecar â†’ under `initContainers:` with `restartPolicy: Always`
* Both mount the same path (e.g., `/var/log`).

---

# ğŸ¯ Exam Strategy for CKA 2025

* ALWAYS use **native sidecar pattern** (initContainers + restartPolicy: Always).
* ONLY use the classic method if the question explicitly says:
  â€œUse a second container inside `containers:` to tail logs.â€
* For all general sidecar tasks: **Native Sidecar = Correct Answer**.

---
