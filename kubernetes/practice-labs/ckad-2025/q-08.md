# Question - 8

## **üìå Question (Exam Style)**

A Deployment named **mydeploy** is running in namespace **analytics**.
It is failing due to RBAC errors.

Look at the Pod logs and you will see messages similar to:

```
Error from server (Forbidden): system:serviceaccount:analytics:default 
cannot list resource "pods" in API group "" in the namespace "analytics"
```

You are provided with:

1. **A requirement to create a new ServiceAccount** named `panther` in the namespace `analytics`.
2. **Three Role manifest files** located in:

   ```
   /opt/roles/
   ```

   Their contents differ in:

   * resources: (`events`, `pods`, `pods/log`)
   * verbs: (`get`, `list`)
3. **No RoleBindings are provided** ‚Äî you must create one.
4. The question explicitly states:

   * *‚ÄúDo NOT modify any of the provided Role manifest files.‚Äù*

### üîß **Your tasks:**

1. Create the ServiceAccount `panther` in the `analytics` namespace.
2. Inspect all three provided Roles and select the **only Role** that satisfies the Pod‚Äôs RBAC requirements.
3. Apply ONLY the correct Role file.
4. Create a new RoleBinding in the same namespace that:

   * Binds the selected Role
   * To the `panther` ServiceAccount
5. Update the Deployment `scanner` so that it uses the `panther` ServiceAccount.
6. Restart the Deployment so the new Pod picks up the new RBAC permissions.
7. Confirm that the logs no longer show Forbidden errors.

---

## **üîç Universal Step ‚Äî Extract Required Permissions From Logs**

üëâ *This is the step you perform as soon as you inspect the logs.*

As soon as you check the Pod logs, you will see one or more Forbidden errors:

```
Error from server (Forbidden): system:serviceaccount:<namespace>:<service-account>
cannot <verb> resource "<resource>" in API group "" in the namespace "<namespace>"
```

From this single log line, extract:

1. **Which ServiceAccount is actually used**
2. **Which resources** the Pod is trying to access
3. **Which verbs** (list / get / watch / etc.)
4. **Whether the scope is namespace or cluster**

   * If log ends with:
     `in the namespace "X"` ‚Üí **Role needed**
   * If log ends with:
     `at the cluster scope` or uses `-A` internally ‚Üí **ClusterRole needed**

### **üîé Step 0 ‚Äî Check Whether the SA Currently Has Those Permissions**

Run:

```bash
kubectl auth can-i <verb> <resource> --as=system:serviceaccount:<ns>:<sa> -n <ns>
```

Example:

```bash
kubectl auth can-i list pods --as=system:serviceaccount:ops:default -n ops
```

You will get:

```
no
```

**This confirms the RBAC issue.**

### ‚≠ê The goal after fixing the RBAC is:

When you run the *exact same* command again:

```bash
kubectl auth can-i <verb> <resource> --as=system:serviceaccount:<ns>:<sa> -n <ns>
```

The answer must now be:

```
yes
```

This means your ServiceAccount + Role/RoleBinding (or ClusterRoleBinding) are correct.

---

## **1Ô∏è‚É£ Understand the Question**

A Deployment is running inside a specific namespace.
Its logs show RBAC failures:

```
Error from server (Forbidden): system:serviceaccount:<namespace>:<sa-name> 
cannot list resource "pods" in API group "" in the namespace "<namespace>"
```

This tells us:

* The app is trying to **list pods**
* The **service account** inside the pod does NOT have correct RBAC access
* The scope is **namespaced** (because logs say *in the namespace‚Ä¶*)

We must fix it using:

* One new **ServiceAccount** (given by question)
* Three provided **Role** manifests (we must choose the correct one)
* A new **RoleBinding** we must create

Goal: make the Deployment able to list pods successfully.

---

## **2Ô∏è‚É£ Step-by-Step Breakdown (Exam Strategy)**

### **Step 1 ‚Äî Create the ServiceAccount**

If the question gives:

```
Create a ServiceAccount named panther in namespace analytics
```

Then:

```bash
kubectl create sa panther -n analytics
```

---

## ‚≠ê **Step 2 ‚Äî Inspect the three provided Roles**

Inside `/opt/roles/` the exam provides three Role manifests.

We must:

* Read all of them
* Identify which Role matches the RBAC error
* Reject the invalid ones

### **Provided Role Manifests**

#### **role1.yaml ‚Äî WRONG**

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: reader-events
  namespace: analytics
rules:
- apiGroups: [""]
  resources: ["events"]
  verbs: ["get", "list"]
```

‚ùå **Wrong because:**

* Resource is `events`
* Deployment needs access to `pods`

---

#### **role2.yaml ‚Äî CORRECT**

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: pod-reader
  namespace: analytics
rules:
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "list"]
```

‚úÖ **Correct because:**

* Resource = `pods`
* Verbs = `get`, `list`
* Scope is namespaced ‚Üí matches error message

---

#### **role3.yaml ‚Äî WRONG**

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: log-reader
  namespace: analytics
rules:
- apiGroups: [""]
  resources: ["pods/log"]
  verbs: ["get", "list"]
```

‚ùå **Invalid Role** because:

* RBAC cannot allow `pods/log` alone
* Must include **pods** as a resource:

Correct form would be:

```yaml
resources:
- pods
- pods/log
```

Since the provided Role does **not** include `pods`,
it can never satisfy the Deployment's error.

---

### **‚û° Therefore: The ONLY correct Role is `role2.yaml`.**

We apply it:

```bash
kubectl apply -f /opt/roles/role2.yaml
```

---

## **Step 3 ‚Äî Create the RoleBinding**

The RoleBinding needs:

* Role: **pod-reader**
* ServiceAccount: **gorilla**
* Namespace: **analytics**

```bash
kubectl create rolebinding panther-rb \
  --role=pod-reader \
  --serviceaccount=analytics:panther \
  -n analytics
```

---

## **Step 4 ‚Äî Patch the Deployment to Use This ServiceAccount**

Two valid methods:

### **Method A ‚Äî Imperative (Fastest for CKAD)**

```bash
kubectl set serviceaccount deployment/mydeploy panther -n analytics
```

### **Method B ‚Äî kubectl edit**

```bash
kubectl edit deployment mydeploy -n analytics
```

Add under `.spec.template.spec`:

```yaml
serviceAccountName: panther
```

---

## **Step 5 ‚Äî Restart Pods so RBAC Takes Effect**

Two valid methods:

### **A ‚Äî Rollout restart**

```bash
kubectl rollout restart deployment mydeploy -n analytics
```

### **B ‚Äî Delete pods manually**

```bash
kubectl delete pod -l app=mydeploy -n analytics
```

---

## **Step 6 ‚Äî Verify Fix**

```bash
kubectl logs deploy/mydeploy -n analytics --since=1m --timestamps
```

You should now see **no RBAC errors**, and the pod successfully lists pods.

---

